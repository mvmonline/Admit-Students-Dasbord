<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 90%; max-width: 400px; text-align: center; }
        .hidden { display: none; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; }
        button { width: 100%; padding: 12px; background: #1a73e8; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .profile-img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #1a73e8; margin-bottom: 15px; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px; text-align: left; }
        .label { font-weight: bold; color: #666; }
        #status { margin-top: 15px; font-size: 13px; color: #555; font-style: italic; }
        .sig-img { width: 150px; border-bottom: 1px solid #333; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card" id="loginBox">
    <h2>Student Login</h2>
    <input type="text" id="sid" placeholder="Student ID">
    <input type="date" id="dob">
    <button onclick="login()">Login</button>
    <div id="status">Ready</div>
</div>

<div class="card hidden" id="dash">
    <img id="p_img" class="profile-img" src="" alt="Photo">
    <h3 id="p_name"></h3>
    <div id="p_details"></div>
    <div style="margin-top:15px">
        <div class="label">Signature</div>
        <img id="p_sig" class="sig-img" src="" alt="Signature">
    </div>
    <div id="qrcode" style="display:flex; justify-content:center; margin-top:20px;"></div>
    <button onclick="location.reload()" style="background:#666; margin-top:20px;">Logout</button>
</div>

<script>
    // YOUR CSV LINK
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvTXVjYcIzEZtESe3zXl2tGIcwPHam8HMPLbjhoBhLp2Mkp3uc_lI9cx12WCv_01psP1vxnSrO7ReV/pub?output=csv';

    function fixDriveUrl(url) {
        if (!url) return "";
        const idMatch = url.match(/[-\w]{25,}/);
        return idMatch ? `https://docs.google.com/uc?export=view&id=${idMatch[0]}` : url;
    }

    async function login() {
        const inputId = document.getElementById('sid').value.trim();
        const inputDob = document.getElementById('dob').value;
        const status = document.getElementById('status');

        if (!inputId || !inputDob) {
            status.innerText = "Error: Please fill all fields";
            return;
        }

        status.innerText = "Connecting to database...";

        try {
            // Using Fetch instead of PapaParse directly to catch CORS errors
            const response = await fetch(CSV_URL);
            if (!response.ok) throw new Error("Could not reach Google Sheets");
            
            const csvText = await response.text();
            
            Papa.parse(csvText, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    const student = results.data.find(row => {
                        // Cleanup keys and values to avoid mismatches
                        const sID = String(row['Student ID'] || "").trim();
                        const sDOB = row['Date of Birth'] || "";
                        
                        // Convert sheet date to YYYY-MM-DD for comparison
                        const dateObj = new Date(sDOB);
                        const formattedSheetDate = !isNaN(dateObj) ? dateObj.toISOString().split('T')[0] : "";
                        
                        return sID === inputId && formattedSheetDate === inputDob;
                    });

                    if (student) {
                        showDashboard(student);
                    } else {
                        status.innerText = "Error: Student ID or Date of Birth not found in Sheet.";
                    }
                }
            });

        } catch (error) {
            status.innerHTML = "<b>Connection Failed!</b><br>Make sure your Sheet is 'Published to Web' as a CSV.";
            console.error(error);
        }
    }

    function showDashboard(s) {
        document.getElementById('loginBox').classList.add('hidden');
        document.getElementById('dash').classList.remove('hidden');

        document.getElementById('p_img').src = fixDriveUrl(s['Photo URL']);
        document.getElementById('p_sig').src = fixDriveUrl(s['Signature URL']);
        document.getElementById('p_name').innerText = s['Student Name'];

        const fields = ['Class', 'Section', 'Roll No', 'Father\'s Name', 'Phone Number', 'Email ID'];
        document.getElementById('p_details').innerHTML = fields.map(f => `
            <div class="info-row">
                <span class="label">${f}:</span>
                <span>${s[f] || 'N/A'}</span>
            </div>
        `).join('');

        new QRCode(document.getElementById("qrcode"), {
            text: s['Student ID'],
            width: 100,
            height: 100
        });
    }
</script>
</body>
</html>
