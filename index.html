<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Portal - Verified</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #1a73e8; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        .hidden { display: none; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #dadce0; border-radius: 8px; box-sizing: border-box; }
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .profile-img { width: 140px; height: 140px; border-radius: 12px; object-fit: cover; border: 3px solid #eee; display: block; margin: 0 auto 15px; background: #eee; }
        .data-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f1f1f1; font-size: 14px; }
        .label { font-weight: bold; color: #5f6368; }
        .signature-box { text-align: center; margin-top: 20px; padding: 10px; border: 1px dashed #ccc; border-radius: 8px; min-height: 60px; }
        .sig-img { max-width: 150px; height: auto; border-bottom: 1px solid #000; }
        #qrcode { display: flex; justify-content: center; margin-top: 20px; }
        #status { color: #d93025; text-align: center; margin-top: 10px; font-size: 14px; }
    </style>
</head>
<body>

<div class="card" id="loginBox">
    <h2 style="text-align:center">Student Login</h2>
    <input type="text" id="sid" placeholder="Student ID">
    <input type="date" id="dob">
    <button onclick="login()">Login to Dashboard</button>
    <div id="status"></div>
</div>

<div class="card hidden" id="dashboard">
    <img id="p_img" class="profile-img" src="" alt="Student Photo">
    <h3 id="p_name" style="text-align:center; margin:0 0 10px 0;"></h3>
    <p id="p_id_label" style="text-align:center; color:var(--primary); font-weight:bold; margin-top:0;"></p>
    
    <div id="p_details"></div>
    
    <div class="signature-box">
        <div class="label" style="font-size:12px; margin-bottom:5px;">Authorized Signature</div>
        <img id="p_sig" class="sig-img" src="" alt="Signature">
    </div>

    <div id="qrcode"></div>
    <button onclick="location.reload()" style="background:#6c757d; margin-top:20px;">Logout</button>
</div>

<script>
    // Your Apps Script API
    const API_URL = 'https://script.google.com/macros/s/AKfycbzuC-IW3al9B62itc1IVHVXsSO9wenrWW5-vDh5KOwCQ692YZizydNoB8091_kqY9EW/exec';

    // Updated Fixer for usp=drivesdk links
    function fixDriveUrl(url) {
        if (!url || typeof url !== 'string') return "";
        // Extract the ID from any Drive URL format
        const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
        if (match && match[1]) {
            // Using the direct thumbnail link which bypasses most blocks
            return `https://lh3.googleusercontent.com/d/${match[1]}=s1000`;
        }
        return url;
    }

    function formatDate(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr);
        return isNaN(d) ? "" : d.toISOString().split('T')[0];
    }

    async function login() {
        const idInput = document.getElementById('sid').value.trim();
        const dobInput = document.getElementById('dob').value;
        const status = document.getElementById('status');

        if (!idInput || !dobInput) {
            status.innerText = "Please enter ID and DOB";
            return;
        }

        status.style.color = "blue";
        status.innerText = "Searching...";

        try {
            const res = await fetch(API_URL);
            const data = await res.json();
            
            const student = data.find(s => {
                const sID = String(s["Student ID"] || "").trim();
                const sDOB = formatDate(s["Date of Birth"]);
                return sID === idInput && sDOB === dobInput;
            });

            if (student) {
                showDashboard(student);
            } else {
                status.style.color = "red";
                status.innerText = "Invalid Login Details.";
            }
        } catch (e) {
            status.innerText = "Connection Error.";
        }
    }

    function showDashboard(s) {
        document.getElementById('loginBox').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');

        // Apply fixed URLs
        document.getElementById('p_img').src = fixDriveUrl(s["Photo URL"]);
        document.getElementById('p_sig').src = fixDriveUrl(s["Signature URL"]);
        
        document.getElementById('p_name').innerText = s["Student Name"];
        document.getElementById('p_id_label').innerText = "ID: " + s["Student ID"];

        const fields = ["Class", "Section", "Roll No", "Father's Name", "Phone Number", "Email ID"];
        document.getElementById('p_details').innerHTML = fields.map(f => `
            <div class="data-row">
                <span class="label">${f}:</span>
                <span>${s[f] || '---'}</span>
            </div>
        `).join('');

        // Generate QR Code
        new QRCode(document.getElementById("qrcode"), {
            text: String(s["Student ID"]),
            width: 100,
            height: 100
        });
    }
</script>
</body>
</html>
