<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Identity Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #1a73e8; --bg: #f8f9fa; --text: #202124; }
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 15px; }
        
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 100%; max-width: 400px; box-sizing: border-box; }
        .hidden { display: none; }
        
        h2 { text-align: center; margin-top: 0; color: var(--primary); }
        label { display: block; margin-top: 15px; font-weight: 600; font-size: 14px; }
        
        input { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #dadce0; border-radius: 8px; box-sizing: border-box; font-size: 16px; transition: border 0.3s; }
        input:focus { border: 2px solid var(--primary); outline: none; }
        
        button { width: 100%; padding: 14px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        button:hover { background: #1557b0; }
        
        .profile-header { text-align: center; margin-bottom: 20px; position: relative; }
        .profile-img { width: 130px; height: 130px; border-radius: 12px; object-fit: cover; border: 3px solid #eee; background: #fafafa; }
        
        .data-container { margin-top: 20px; border-top: 1px solid #eee; }
        .data-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f8f9fa; font-size: 14px; }
        .data-label { color: #5f6368; font-weight: 500; }
        .data-value { color: #202124; font-weight: 600; text-align: right; }
        
        .signature-box { text-align: center; margin-top: 20px; padding: 10px; background: #fff; border: 1px dashed #ccc; border-radius: 8px; }
        .signature-img { max-width: 160px; height: auto; display: block; margin: 5px auto; filter: contrast(1.2); }
        
        #qrcode { margin-top: 25px; display: flex; justify-content: center; }
        #status { text-align: center; color: #d93025; font-size: 14px; margin-top: 15px; min-height: 20px; }
        
        .loading-spinner { border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; width: 20px; height: 20px; animate: spin 1s linear infinite; display: inline-block; margin-right: 10px; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="card" id="loginBox">
    <h2>Student Portal</h2>
    <p style="text-align:center; color:#5f6368; font-size:14px;">Enter details to view dashboard</p>
    
    <label>Student ID</label>
    <input type="text" id="sid" placeholder="e.g. 12345">
    
    <label>Date of Birth</label>
    <input type="date" id="dob">
    
    <button onclick="processLogin()">View My Dashboard</button>
    <div id="status"></div>
</div>

<div class="card hidden" id="dashboard">
    <div class="profile-header">
        <img id="view_photo" class="profile-img" src="" alt="Student Photo">
        <h3 id="view_name" style="margin: 10px 0 5px 0;"></h3>
        <p id="view_id_label" style="margin:0; color:var(--primary); font-weight:bold; font-size:14px;"></p>
    </div>

    <div class="data-container" id="view_details">
        </div>

    <div class="signature-box">
        <span class="data-label" style="font-size:12px;">Authorized Signature</span>
        <img id="view_sig" class="signature-img" src="" alt="Signature">
    </div>

    <div id="qrcode"></div>
    
    <button onclick="window.location.reload()" style="background:#5f6368;">Logout</button>
</div>

<script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzuC-IW3al9B62itc1IVHVXsSO9wenrWW5-vDh5KOwCQ692YZizydNoB8091_kqY9EW/exec';

    // Function to convert Drive links to direct image source
    function formatDriveUrl(url) {
        if (!url || typeof url !== 'string') return "";
        const idMatch = url.match(/[-\w]{25,}/);
        return idMatch ? `https://docs.google.com/uc?export=view&id=${idMatch[0]}` : url;
    }

    // Function to normalize dates for accurate comparison
    function normalizeDate(dateVal) {
        if (!dateVal) return "";
        const d = new Date(dateVal);
        if (isNaN(d.getTime())) return "";
        return d.toISOString().split('T')[0]; // Format: YYYY-MM-DD
    }

    async function processLogin() {
        const idInput = document.getElementById('sid').value.trim();
        const dobInput = document.getElementById('dob').value;
        const status = document.getElementById('status');

        if (!idInput || !dobInput) {
            status.innerText = "Error: All fields are required.";
            return;
        }

        status.innerHTML = '<div class="loading-spinner"></div> Connecting...';
        status.style.color = "var(--primary)";

        try {
            const response = await fetch(API_URL);
            const students = await response.json();

            // Find match
            const student = students.find(s => {
                const sheetID = String(s["Student ID"] || "").trim();
                const sheetDOB = normalizeDate(s["Date of Birth"]);
                return sheetID === idInput && sheetDOB === dobInput;
            });

            if (student) {
                renderDashboard(student);
            } else {
                status.innerText = "Error: Invalid ID or Date of Birth.";
                status.style.color = "#d93025";
            }
        } catch (error) {
            console.error(error);
            status.innerText = "Connection Failed. Please check internet.";
            status.style.color = "#d93025";
        }
    }

    function renderDashboard(s) {
        document.getElementById('loginBox').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');

        // Set Images
        document.getElementById('view_photo').src = formatDriveUrl(s["Photo URL"]);
        document.getElementById('view_sig').src = formatDriveUrl(s["Signature URL"]);
        
        // Set Header
        document.getElementById('view_name').innerText = s["Student Name"] || "N/A";
        document.getElementById('view_id_label').innerText = "ID: " + s["Student ID"];

        // Set Detail List
        const fields = [
            ["Class", s["Class"]],
            ["Section", s["Section"]],
            ["Roll No", s["Roll No"]],
            ["Father's Name", s["Father's Name"]],
            ["Phone", s["Phone Number"]],
            ["Email", s["Email ID"]]
        ];

        document.getElementById('view_details').innerHTML = fields.map(item => `
            <div class="data-row">
                <span class="data-label">${item[0]}</span>
                <span class="data-value">${item[1] || '---'}</span>
            </div>
        `).join('');

        // Generate QR Code
        document.getElementById("qrcode").innerHTML = "";
        new QRCode(document.getElementById("qrcode"), {
            text: `STUDENT_ID:${s["Student ID"]}`,
            width: 100,
            height: 100,
            colorDark : "#202124",
            colorLight : "#ffffff",
            correctLevel : QRCode.CorrectLevel.H
        });
    }
</script>

</body>
</html>
