<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Data Portal</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #eef2f3; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        .container { background: white; padding: 2rem; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 450px; transition: all 0.3s ease; }
        h2 { text-align: center; color: var(--primary); margin-bottom: 1.5rem; }
        
        /* Login Styles */
        .input-group { margin-bottom: 1rem; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #666; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        button { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; margin-top: 10px; }
        button:hover { background: #2980b9; }
        
        /* Dashboard Styles */
        .hidden { display: none; }
        .profile-section { text-align: center; margin-bottom: 20px; }
        .photo-frame { width: 120px; height: 120px; border-radius: 10px; border: 3px solid var(--accent); object-fit: cover; margin-bottom: 10px; background: #f9f9f9; }
        
        .info-grid { border-top: 2px solid #eee; padding-top: 15px; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
        .info-label { font-weight: bold; color: #7f8c8d; }
        .info-value { color: #2c3e50; text-align: right; }
        
        .sig-section { margin-top: 15px; text-align: center; }
        .sig-img { max-width: 150px; height: auto; border-bottom: 1px solid #333; margin-top: 5px; }
        
        #qrcode { display: flex; justify-content: center; margin-top: 20px; padding: 10px; background: white; }
        .error { color: #e74c3c; text-align: center; font-size: 14px; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container" id="app">
    <div id="login-form">
        <h2>Student Login</h2>
        <div class="input-group">
            <label>Student ID</label>
            <input type="text" id="sid" placeholder="Enter your ID (e.g. 101)">
        </div>
        <div class="input-group">
            <label>Date of Birth</label>
            <input type="date" id="dob">
        </div>
        <button onclick="handleLogin()">Verify Details</button>
        <div id="msg" class="error"></div>
    </div>

    <div id="dashboard" class="hidden">
        <div class="profile-section">
            <img id="photo" class="photo-frame" src="" alt="Student Photo">
            <h3 id="student-name" style="margin: 5px 0;"></h3>
            <span id="student-class" style="color: var(--accent); font-weight: bold;"></span>
        </div>

        <div class="info-grid" id="details-list">
            </div>

        <div class="sig-section">
            <div class="info-label">Student Signature</div>
            <img id="signature" class="sig-img" src="" alt="Signature">
        </div>

        <div id="qrcode"></div>
        
        <button onclick="window.location.reload()" style="background: #95a5a6;">Close Dashboard</button>
    </div>
</div>

<script>
    // Your provided published CSV link
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQvTXVjYcIzEZtESe3zXl2tGIcwPHam8HMPLbjhoBhLp2Mkp3uc_lI9cx12WCv_01psP1vxnSrO7ReV/pub?output=csv';

    // Helper to fix Google Drive View Links to Direct Image Links
    function formatDriveUrl(url) {
        if (!url || !url.includes('drive.google.com')) return url;
        const idMatch = url.match(/\/d\/([^/]+)/);
        if (idMatch && idMatch[1]) {
            return `https://docs.google.com/uc?export=view&id=${idMatch[1]}`;
        }
        return url;
    }

    function handleLogin() {
        const inputId = document.getElementById('sid').value.trim();
        const inputDob = document.getElementById('dob').value;
        const errorMsg = document.getElementById('msg');

        if (!inputId || !inputDob) {
            errorMsg.innerText = "Please fill in both fields.";
            return;
        }

        Papa.parse(CSV_URL, {
            download: true,
            header: true,
            complete: function(results) {
                const data = results.data;
                // Find student matching ID and DOB
                const student = data.find(row => 
                    String(row['Student ID']).trim() === inputId && 
                    row['Date of Birth'] === inputDob
                );

                if (student) {
                    renderDashboard(student);
                } else {
                    errorMsg.innerText = "No student found with these credentials.";
                }
            },
            error: function() {
                errorMsg.innerText = "Error connecting to database.";
            }
        });
    }

    function renderDashboard(student) {
        document.getElementById('login-form').classList.add('hidden');
        document.getElementById('dashboard').classList.remove('hidden');

        // Set Images (using the URL fixer)
        document.getElementById('photo').src = formatDriveUrl(student['Photo URL']);
        document.getElementById('signature').src = formatDriveUrl(student['Signature URL']);
        
        // Set Header
        document.getElementById('student-name').innerText = student['Student Name'];
        document.getElementById('student-class').innerText = `${student['Class']} - ${student['Section']}`;

        // Set List of Details
        const list = document.getElementById('details-list');
        const fieldsToShow = [
            ['Roll No', 'Roll No'],
            ['Father Name', "Father's Name"],
            ['Phone', 'Phone Number'],
            ['Email', 'Email ID'],
            ['DOB', 'Date of Birth']
        ];

        list.innerHTML = fieldsToShow.map(field => `
            <div class="info-row">
                <span class="info-label">${field[0]}</span>
                <span class="info-value">${student[field[1]] || 'N/A'}</span>
            </div>
        `).join('');

        // Generate QR Code for the Student ID
        document.getElementById("qrcode").innerHTML = ""; // Clear old QR
        new QRCode(document.getElementById("qrcode"), {
            text: `STUDENT_ID:${student['Student ID']}`,
            width: 100,
            height: 100,
            colorDark : "#2c3e50",
            colorLight : "#ffffff"
        });
    }
</script>

</body>
</html>
